<div class="container-fluid">
	<div class="row">
		<%= render "shared/sidebar" %>

		<main role="main" class="col-md-9 col-lg-10 py-5">
      <div class="col-md-6 offset-md-3 mt-md-5">
        <div>
          <video id="video_area" style="background-color:#000;max-width:400px;height:300px;" autoplay></video>        
        </div>
        <div>
          <button id="start_btn" class="d-none">表示</button>
          <button id="start_face_recognition" class="btn btn-secondary">認証START</button>
        </div>
        <div id="results" class="mt-3">
          <div id="search-result-list">カメラに向かって正面を向き、「認証START」を押してください。</div>
        </div>
        <div>
          <canvas id="capture_image" style="width:400px;height:300px;display:none;"></canvas>
        </div>

      </div>
    </main>

  </div>
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script type="text/javascript">
if (typeof navigator.mediaDevices.getUserMedia !== 'function') {
  var err = new Error('getUserMedia()が利用できないブラウザです');
  alert(`${err.name} ${err.message}`);
  throw err;
}

var $start = document.getElementById('start_btn');
var $video = document.getElementById('video_area');

var disabledToggle = (ele) => {
  $(ele).prop('disabled', !$(ele).prop('disabled'));
}

var stop = () => {
  video_area.srcObject.getTracks().forEach(t => t.stop());
};

var showMedia = () => {
  navigator.mediaDevices.getUserMedia({ video: true, audio: false })
  .then(stream => $video.srcObject = stream)
  .catch(err => alert(`${err.name} ${err.message}`));
}
showMedia();

var showMatchedImages = (result) => {
  $('#results').hide();
  $("#search-result-list").empty();
  if ( result.face_matches.length != 0 ) {
    $('#search-result-list').append('<div>認証が成功しました。</div>');
  } else {
    $('#search-result-list').append('<div>認証が失敗しました。再度試してください。</div>');
  }
  $('#results').show();
}

$("#start_face_recognition").click(function() {
  disabledToggle('#start_face_recognition');
  $("#search-result-list").empty();
  $('#search-result-list').append('<div>--- 認証中 ---</div>');

  var canvas_capture_image = document.getElementById('capture_image');
  var cci = canvas_capture_image.getContext('2d');

  var w = $video.offsetWidth;
  var h = $video.offsetHeight;

  canvas_capture_image.setAttribute("width", w);
  canvas_capture_image.setAttribute("height", h);

  cci.drawImage($video, 0, 0, w, h);

  var data = {
    "img_src": canvas_capture_image.toDataURL('image/jpeg')
  };

  $.ajax({
    url: '<%= face_login_check_path %>',
    method: 'post',
    dataType: 'json',
    data: data,
  }).done(function( res ) {
    $('#start_btn').click();
    console.log( 'SUCCESS', res.result );
    showMatchedImages(res.result);
    if (res.result.face_matches.length != 0) {
      window.location.href = '/'
    } else {
      disabledToggle('#start_face_recognition');
    }
  }).fail(function( jqXHR, textStatus, errorThrown ) {
    $('#start_btn').click();
    console.log( 'ERROR', jqXHR, textStatus, errorThrown );
    showMatchedImages([]);
    disabledToggle('#start_face_recognition');
  });
});

// ページ遷移時にvideoをoffにする
$("a").on('click',function(event){
  stop();
});

// ブラウザバックした時にvideoをoffにする
history.replaceState(null, document.getElementsByTagName('title')[0].innerHTML, null);
window.addEventListener('popstate', function(e) {
  stop();
});
</script>
